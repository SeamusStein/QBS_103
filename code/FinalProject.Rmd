# Seamus Stein
### QBS 103
### Presentation 1
### July 25

### APOM Gene information

The APOM gene encodes a protein that is an apolipoprotein. The encoded protein is secreted through the plasma membrane but remains membrane-bound. It functions in the transportation of lipids. 

```{r}
# set working directory to data folder
setwd("/Users/seamus/QBS_103_Project/QBS_103/QBS_103_Data")

# read in gene expression and metadata files 
gene_expression <- read.csv(file = "QBS103_finalProject_geneExpression.csv", row.names = 1)

meta_data <- read.csv(file = "QBS103_finalProject_metadata.csv", row.names = 1)

# subset APOM_expression data. 
APOM_expression <- gene_expression["APOM",]
# apply transform to make the rows into columns 
APOM_expression <- as.data.frame(t(APOM_expression))
head(APOM_expression)
```


``` {r}
# Link metadata to APOM gene expression data
metadata_APOM_expression <- cbind(meta_data, APOM_expression)
head(metadata_APOM_expression)
```


Using ggplot2 generate the following plots for your covariates of choice

a) Histogram for gene expression
```{r}
library(tidyverse)
myTheme <- theme(
  panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), 
  # define axis
  axis.line = element_line(colour = "black", linewidth = rel(1)),
  # plot background
  plot.background = element_rect(fill = "white"),
  panel.background = element_blank(),
  legend.key = element_rect(fill = 'white'), 
  # Move legend
  legend.position = 'right',
  
  # font
  text = element_text(family = 'Georgia', size = 14 ), 
  
  # center titles
  plot.title = element_text(hjust = 0.5)
)
```

```{r}
# define color pallete for APOM expression histogram
colorPalette<- c('#FCDCDC')

# plot histogram of APOM expression 
ggplot(metadata_APOM_expression, aes(x = APOM)) +
  geom_histogram(binwidth = 1, col = 'black', fill = colorPalette ) +
  ggtitle(expression("Histogram of "~italic(APOM)~ " expression")) +
  labs(x = expression(~italic(APOM)~ " Expression"), y = "Frequency of People") +
  myTheme
```

b) Scatter plot for gene expression and continuous covariate age

```{r}
# convert character age to numeric
metadata_APOM_expression$age <- as.numeric(metadata_APOM_expression$age)
head(metadata_APOM_expression)
```
```{r}
# scatter plot for gene expression and age
ggplot(metadata_APOM_expression, aes(x = age, y = APOM)) +
  geom_point(color = "navy") +
  labs(x = "Age (years)", y = expression(~italic(APOM)~ "Expression")) +
  ggtitle(expression(~italic(APOM)~ " Expression by Age")) +
  myTheme
```

c) Boxplot of gene expression separated by both categorical covariates 
Categorical covariates: Sex, icu_status


```{r}
# convert unknown sex to NA
metadata_APOM_expression$sex <- if_else(metadata_APOM_expression$sex == " unknown", NA, metadata_APOM_expression$sex)

```


```{r}
# clean the data by filtering so sex has no NA
APOM_clean <- metadata_APOM_expression %>% 
      filter(!is.na(sex))
```



```{r}
#define color pallete for box plot
colorPalette2 <- c("#db6d00", "#B6DBFF")

# create box plot of gene expression separated by ICU status and sex
ggplot(APOM_clean, aes(x = icu_status, y = APOM, fill = sex)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitterdodge(0.2))+
  #geom_jitter() +
  scale_x_discrete(labels = c("Not Admitted", "Admitted")) +
  labs(x = "ICU Status", y = expression(~italic(APOM)~ " Expression")) +
  scale_fill_manual(values = colorPalette2) +
  ggtitle(expression(~italic(APOM)~ " Exprsession by ICU Status and Sex")) +
  myTheme
```


# Presentation 2
## August 8, 2023

```{r}
# function to create histogram. 
#Takes in the data frame and a singular gene of interest 
createHistogram <- function(df, gene) {
    # create label pieces 
    gene_label <- c(gene)
    labNames <- c('Frequency of Patients with', "Expression")
    
    # create dynamic title 
    my_title <- eval(bquote(expression(.(labNames[1]) ~ italic(.(gene_label[1])) ~ .(labNames[2]))))
  
    #create dynamic x axis label
    my_x <- eval(bquote(expression(~ italic(.(gene_label[1])) ~ .(labNames[2]))))
    #create the histogram
    histogram <-  ggplot(df, aes(x = .data[[gene]])) +
                        geom_histogram(binwidth = 1, col = 'black', fill = colorPalette ) +
                        labs(x = my_x, y = "Frequency of Patients", title = my_title) +
                        myTheme
    # display histogram
    histogram 
}

```




```{r}
# create scatter plot function. 
#Takes in the data frame, gene, continuous variable, x axis variable and the 
#x-axis variable name for title

createScatterplot <- function(df, gene, conVar, xaxis, x_var_label) {
    # create label pieces
    gene_label <- c(gene)
    labNames <- c(x_var_label,'by', "Expression")
    
    # create dynamic title label
    my_title <- eval(bquote(expression(~italic(.(gene_label[1])) ~ .(labNames[3]) ~ .(labNames[2])
                                       ~ .(labNames[1]))))
    
    # create dynamic y axis title 
    my_y <- eval(bquote(expression(~ italic(.(gene_label[1])) ~ .(labNames[3]))))
    
    #create scatter plot
    scatter_plot <- ggplot(df, aes(x = .data[[conVar]], y = .data[[gene]])) +
                  geom_point(color = "navy") +
                  labs(x = xaxis,  y = my_y, title = my_title) +
                  myTheme
  #display scatter plot
  scatter_plot
}
```

```{r}
# create boxplot function, takes in data frame, gene, x-axis categorical variable, categorical  variable for the color
# 2 tick labels (1 parameter each) label for the x axis categorical variable, label for x fill  
createBoxplot <- function(df, gene, xCat, colorCatVar, tick_label_1, tick_label_2, x_catLabel, x_fill_label) {
  # create label pieces
  gene_label <- c(gene)
  labNames <- c("Expression", "by", x_catLabel, "and", x_fill_label)
  
  # create dynamic title label
  my_title <- eval(bquote(expression(~italic(.(gene_label[1])) ~ .(labNames[1]) ~ .(labNames[2])
                                       ~ .(labNames[3]) ~ .(labNames[4]) ~ .(labNames[5]))))
  # create dynamic y axis title 
  y_axis_title <- eval(bquote(expression(~italic(.(gene_label[1])) ~ .(labNames[1]))))
  
  # create boxplot
  myBoxplot <- ggplot(df, aes(x = .data[[xCat]], y = .data[[gene]], fill = .data[[colorCatVar]])) + 
               geom_boxplot(outlier.shape = NA) +
               geom_point(position = position_jitterdodge(0.2))+
               scale_x_discrete(labels = c(tick_label_1, tick_label_2)) +
               labs(x = x_catLabel, y = y_axis_title,
                    title = my_title) +
               scale_fill_manual(values = colorPalette2) +
               myTheme
  #display boxplot
  myBoxplot
}
```

```{r}
#createBoxplot(APOM_clean, "APOM", "icu_status", "sex", "Not Admited", "Admitted","ICU Status", "Sex")
```

```{r}
#createScatterplot(APOM_clean, "APOM", "age", "Age (years)", "Age")
```

### Subset multiple genes for analysis

```{r}
# subset multiple genes data. 
gene_subset <- gene_expression[c("APOM", "APOA2","LCN2"),]
# apply transform to make the rows into colmnns 
gene_subset <- as.data.frame(t(gene_subset))
head(gene_subset)
```

```{r}
# Link metadata to gene subset data
metadata_gene_expression <- cbind(meta_data, gene_subset)
head(metadata_gene_expression)

```

```{r}
# convert unknown sex to NA
metadata_gene_expression$sex <- if_else(metadata_gene_expression$sex == " unknown", NA, metadata_gene_expression$sex)

```

```{r}
# convert character age to numeric
metadata_gene_expression$age <- as.numeric(metadata_APOM_expression$age)
head(metadata_gene_expression)
```


```{r}
# clean the data by filtering so sex has no NA
gene_clean <- metadata_gene_expression %>% 
      filter(!is.na(sex))

head(gene_clean)
```

```{r}
# This function makes the plots and takes in a vector of 1 continuous variable
# and a vector of 2 categorical variables

makePlots <- function(df, geneNames, x_Cont, xCat) {
  #the x axis categorical variable in box plot
  x_cat <- xCat[1]
  # the categorical variable indicated by color fill
  cat_col = xCat[2]
  
  # create the plots by calling functions
  myHist <- createHistogram(df, geneNames)
  myScatter <- createScatterplot(df, geneNames, x_Cont, "Age (years)", "Age")
  myBox <- createBoxplot(df, geneNames, x_cat, cat_col, "Not Admited", "Admitted","ICU Status", "Sex")
  
  #store the plots in a list
  plots <- list(myBox, myHist, myScatter)
  
 # display the plots
 plots
}
```


```{r}
# define variables of interest to pass in the make plots function 
categorical <- c("icu_status", "sex")
continous_vars <- c("age")
geneNames <- c("APOM", "LCN2", "APOA2")
```


```{r}

# loop through the gene names and print all of the plots using makePlots function
for(item in 1:length( geneNames)){
  gene_plots <- makePlots(gene_clean, geneNames[item], continous_vars, categorical)
  print(gene_plots)
}

```

#### References
https://stackoverflow.com/questions/31927984/using-italic-with-a-variable-in-ggplot2-title-expression
https://www.appsloveworld.com/r/100/2/combining-paste-and-expression-functions-in-plot-labels


